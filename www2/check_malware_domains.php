<?php

$url = "http://mirror1.malwaredomains.com/files/domains.txt";

$domains = array();


$DATABASE = "127.0.0.1";
$DBUSER   = "pdns";
$DBTABLE  = "pdns";
$DBPASSWD = "pdns";

$pdo = new PDO("mysql:host=$DATABASE;dbname=$DBTABLE", $DBUSER, $DBPASSWD);


$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);;
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
$data = curl_exec($ch);

if ($data=== false){
    var_dump(curl_error($ch));
    die("Could not load URL");
}

$data = explode("\n", $data);

foreach($data as $line) {
    $line = trim($line);
    if (!isset($line[0]) || $line[0] == '#') continue;
    $tmp = explode("\t", $line);
    $urls[] = $tmp[1];
}

foreach ($urls as $url) {
    $sql = "SELECT min(FIRST_SEEN) as FS, max(LAST_SEEN) as LS, count(*) as cnt FROM pdns WHERE QUERY = '$url'";
    $stmt = $pdo->prepare($sql);
    $stmt->execute();
    $row = $stmt->fetch(PDO::FETCH_ASSOC);
    if($row['cnt'] > 0) {
        echo "Found malware domain in data set : $url\n";
        echo "  Record first seen: " . $row['FS'] . ", last seen: " . $row['LS']. "\n";
    }
}

echo "\nchecked " . count($urls) . " malware urls\n\n";
